<!DOCTYPE html>
<html lang="en">
<head>
<title>Initializing</title>
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
<link rel="icon" href="/favicon.ico" type="image/x-icon">
<script src="/jquery/jquery-3.2.1.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.11/ace.min.js" type="text/javascript" charset="utf-8"></script>
<style type="text/css" media="screen">
body {
	background: #222;
	font-family: Verdana, Geneva, sans-serif;
	font-style: normal;
}
#editor {
	position: absolute;
	top: 40px;
	right: 0px;
	bottom: 0px;
	left: 10px;
}
.logo {
	position:absolute;
	right: 5px;
	top: 2px;
}
.discord-logo {
	position: absolute;
	right: 15px;
	top: 80px;
}
#tools {
	position: absolute;
	top: 0px;
	right: 10px;
	left: 10px;
	height: 36px;
}
#context {
	position: absolute;
	top: 4px;
	left: 0px;
	width: 80px;
	height: 21px;
	padding: 1px 4px;
	background: #222;
	color: #fff;
	font-family: Verdana, Geneva, sans-serif;
	font-size: 12px;
	font-style: normal;
	border: 1px solid #666;
	border-radius: 2px;
	outline: none;
}
#path {
	position: absolute;
	top: 4px;
	left: 84px;
	height: 15px;
	width: 600px;
	padding: 2px 4px;
	background: #222;
	color: #fff;
	font-family: Verdana, Geneva, sans-serif;
	font-size: 12px;
	font-style: normal;
	border: 1px solid #666;
	border-radius: 2px;
	outline: none;
	z-index: 20;
}
#suggestion {
	display: none;
	position: fixed;
	top: 24px;
	left: 94px;
	width: 608px;
	padding: 0;
	font-size: 12px;
	color: #fff;
	font-family: Verdana, Geneva, sans-serif;
	font-size: 12px;
	font-style: normal;
	border: 1px solid #666;
	border-top: none;
	border-radius: 2px;
	background: #222;
	z-index: 21;
}
#suggestion div {
	border-top: 1px solid #666;
	padding: 2px 4px;
	cursor: pointer;
}
#suggestion div.selected,
#suggestion div:hover {
	background: #444;
}
#actions {
	position: absolute;
	top: 4px;
	left: 698px;
	width: 80px;
	height: 21px;
	padding: 1px 4px;
	background: #222;
	color: #fff;
	font-family: Verdana, Geneva, sans-serif;
	font-size: 12px;
	font-style: normal;
	border: 1px solid #666;
	border-radius: 2px;
	outline: none;
}
#hints {
	position: absolute;
	top: 28px;
	left: 0px;
	color: #ccc;
	font-family: Verdana, Geneva, sans-serif;
	font-size: 8px;
	font-style: normal;
}
#status {
	position: absolute;
	top: 28px;
	left: 200px;
	color: #ccc;
	font-family: Verdana, Geneva, sans-serif;
	font-size: 8px;
	font-style: normal;
}
</style>
</head>
<body>
 <div id="tools">
	<select id="context">
		<option>private</option>
		<option>shared</option>
		<!-- option>world</option -->
	</select>
	<input type="text" id="path" />
	<select id="actions">
		<option value="">actions</option>
		<option id="rename">rename</option>
		<option id="delete">delete</option>
	</select>
	<div id="suggestion"></div>
	<span id="hints">Save: Ctrl-S / Open: Ctrl-O / Reload: Ctrl-R<!-- / Find: Ctrl-F --></span>
	<span id="status"></span>
 </div>
 <div id="editor"></div>
 <a href="http://www.wizards-of-lua.net/spellbooklibrary" target='wol-api-docs'><img class="logo" 
	src="/steven-with-magic-wand-glowing.png"
	alt="Open API docs at wizards-of-lua.net"
	height="70"
	></a>
 <a href="https://discord.gg/9En5Drt" target='wol-discord-channel'><img class="discord-logo" 
	src="/discord-logo.png"
	alt="Join our Discord channel"
	height="70"
	></a>
 <script>
		var loaded = false;
		var doMarkClean = false;

		var filename = window.location.href;
		var filepath = '';
		var urlparts = window.location.href.match('^(.+)\/wol\/lua\/([\\w-]+)\/(.+)$');

		var playerUuid = '';
		var lastModified = '';
		var fileExists = false;

		ace.config.set('basePath', 'https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.11');
		var editor = ace.edit('editor');

		editor.session.setTabSize(2);
		editor.setTheme('ace/theme/twilight');
		editor.setHighlightActiveLine(true);
		editor.$blockScrolling = Infinity;

		editor.commands.addCommand({
			name: 'save',
			bindKey: {win: 'Ctrl-S', mac: 'Cmd-S'},
			exec: function(editor) {
				document.title = 'Saving '+filepath;
				var json = JSON.stringify({ path: filename, content: editor.getValue()});
				$.ajax({
					type: 'POST',
					url: filename,
					data: json,
					contentType: 'application/json',
					success: function(response) {
						document.location.reload();
					}
				})
				.fail(function(response) {
					console.log('ERROR saving file');
					console.log(response);
					alert('Unable to save file.');
					document.title = filepath;
				});
			}
		})

		editor.commands.addCommand({
			name: 'open',
			bindKey: {win: 'Ctrl-O', mac: 'Cmd-O'},
			exec: function(editor) {
				$('#path').focus();
			}
		})
		
		function setModified(modified) {
			if (modified) {
				document.title = '\u25CF '+filepath;
			} else {
				editor.session.getUndoManager().markClean();
				document.title = filepath;
			}
		}
		
		editor.on('input', function() {
			if (doMarkClean) {
				setModified(false);
				doMarkClean = false;
			} else {
				setModified(!editor.session.getUndoManager().isClean()); 
			}
		});

		function loadContent() {
			loaded = false;
			document.title = 'Loading '+filename;
			$.ajax({
				dataType: 'json',
				url: filename+'?',
				success: function(data) {
					if (data.type == 'directory') window.location	= '/wol/lua/shared/welcome.txt';

					filepath = data.path;
					lastModified = new Date(data.lastModified);
					fileExists = data.exists;
					playerUuid = data.playerUuid;

					if (fileExists) {
						var date = lastModified.toISOString().substring(0,10)+' '+lastModified.toISOString().substring(11,19);
						$('#status').text('Last modified: '+date);
					} else {
						$('#status').text('This file does not exist yet. It will be created when you save.');						
						$('#actions').attr('disabled','true');
						$('#actions').css('color','#888');
					}

					var extension = data.name.match('\\.(\\w+)$');
					if (extension) switch (extension[1]) {
						case 'html':
							editor.session.setMode('ace/mode/html');
							break;
						case 'lua':
							editor.session.setMode('ace/mode/lua');
							break;
						case 'md':
							editor.session.setMode('ace/mode/markdown');
							break;
						case 'xml':
							editor.session.setMode('ace/mode/xml');
							break;
					}

					editor.setValue(data.content ? data.content:'');
					editor.clearSelection();
					editor.focus();

					setModified(false);
					document.title = filepath;

					loaded = true;
					doMarkClean = true;
				},
				error: function(data) {
					console.log('ERROR loading file');
					console.log(data);
					alert('Unable to load file.');
					document.title = filepath;
				} 
			});
		}

		$(document).ready(function() {
			if (!loaded) loadContent();
			if (urlparts[2] == 'shared' || urlparts[2] == 'world') {
				$('#context').val(urlparts[2]);
			} else {
				$('#context').val('private');            
			}
			$('#path').val(urlparts[3]);
		});

/*
		Autocomplete Fileselect
		added 20-05-29 by bytemage
*/

		var suggestions = [];
		var suggestionSelect = 0;
		var suggestionCursor = 0;
		var suggestionClick = false;

		var renameActive = false;

		function requestSuggestions() {
			var context = $('#context').val();
			var path = $('#path').val().substring(0,suggestionCursor);
			$.ajax({
				dataType: 'json',
				url: urlparts[1] + '/wol/autocomplete?c='+context+'&p='+path,
				success: function(data) {
					uuid = data.playerUuid;
					suggestions = data.matches.sort();
					$('#suggestion').empty();
					suggestions.forEach(element => $('#suggestion').append('<div>'+element+'</div>'));
					$('#suggestion div').click(function(event) { clickSuggestion(event) });
					highlightSuggestion();
					$('#suggestion').css('display','block');
					$('#path').focus();
				},
				error: function(data) {
					console.log('ERROR requesting suggestions');
					console.log(data);
					alert('Error while requesting suggestions from server.');
				} 
			});
		}

		function resetSuggestions() {
			$('#path').val(urlparts[3]);
			$('#suggestion').css('display','none');
			suggestionSelect = 0;
			suggestionClick = false;

			if (renameActive) {
				$('#status').text('');
				renameActive = false;
			}

		}

		function clickSuggestion(event) {
			suggestionClick = true;
			$('#path').focus();
			takeSuggestion(event.target.innerText);
			executeAction();
		}

		function takeSuggestion(text) {
			$('#suggestion').css('display','none');
			$('#path').val(text);
			suggestionCursor = text.length;
			suggestionSelect = 0;
			requestSuggestions();
		}

		function highlightSuggestion() {
			$('#suggestion div').removeClass('selected');
			if (suggestionSelect)
				$('#suggestion div:eq('+(suggestionSelect-1)+')').addClass('selected');
		}

		function confirmDiscard() {
			if (editor.session.getUndoManager().isClean()) return true;
			return confirm('You have unsaved changes.\nDo you want to discard them?');
		}

		function executeAction() {
			var path = $('#path').val();
			var context = $('#context').val();
			if (context == 'private') context = playerUuid;

//			if (!path.match('([\\w-]+)\\.([\\w-]+)$')) return;
			if (path.endsWith('/')) return;
			if (path+'/' == suggestions[0]) return;

			if (renameActive) {

				$.ajax({
					type: 'POST',
					url: filename+'?mv=' + path,
					data: '',
					contentType: 'application/json',
					success: function(response) {
						window.location = response.url;
					}
				})
				.fail(function(response) {
					console.log('ERROR renaming file');
					console.log(response);
					alert('Unable to rename file.');
					document.title = filepath;
					$('#status').text('');
					renameActive = false;
				});
	
			} else {
	
				if (!confirmDiscard()) {
					$('#path').val(urlparts[3]);
					return;
				}
				window.location = urlparts[1] + '/wol/lua/' + context + '/' + path;
	
			}
		}

		$('#context').change(function() {
			if (!confirmDiscard()) {
				if (urlparts[2] == 'shared' || urlparts[2] == 'world') {
					$('#context').val(urlparts[2]);
				} else {
					$('#context').val('private');            
				}
				return;
			}
			var context = $('#context').val();
			if (context == 'private') context = playerUuid;
			var path = $('#path').val();
			window.location = urlparts[1] + '/wol/lua/' + context + '/' + path;
		});

		$('#path').keydown(function(event) {
			if (event.which == 9) event.preventDefault();
			if (event.which == 190 && $('#path').val() == '') event.preventDefault();
		});

		$('#path').keyup(function(event) {
			suggestionCursor = event.target.selectionStart;
			switch (event.which) {
				case 9: // tab
					if (suggestionSelect)
						takeSuggestion(suggestions[suggestionSelect-1]);
					break;
				case 13: // return
					if (suggestionSelect)
						takeSuggestion(suggestions[suggestionSelect-1]);
					executeAction();
					break;
				case 27: // esc
					resetSuggestions();
					editor.focus();
					break;
				case 38: // up
					if (suggestionSelect) suggestionSelect--;
					highlightSuggestion();
					break;
				case 40: // down
					if (suggestionSelect < suggestions.length) suggestionSelect++;                
					highlightSuggestion();
					break;
				default:
					requestSuggestions();
			}
		});

		$('#path').click(function(event) {
			suggestionCursor = event.target.selectionStart;
			requestSuggestions();
		});

		$('#path').blur(function() {
			setTimeout(function() {
				if (suggestionClick == true) {
					suggestionClick = false;
				} else {
					resetSuggestions();
				}
			}, 500);
		});

		$('#actions').change(function() {
			var action = $('#actions').val();
			$('#actions').val('');
			switch (action) {

				case 'rename':
					if (!confirmDiscard()) return;
					$('#status').text('RENAME MODE: Change the filename and press ENTER to rename it.');
					$('#path').focus();
					renameActive = true;
					break;

				case 'delete':
					if (!confirm('Are you sure you want to delete this file?\nThis action is irreversible.')) return;
					$.ajax({
						type: 'DELETE',
						url: filename,
						data: '',
						contentType: 'application/json',
						success: function(response) {
							window.location	= '/wol/lua/shared/welcome.txt';
						}
					})
					.fail(function(response) {
						console.log('ERROR deleting file');
						console.log(response);
						alert('Unable to delete file.');
					});
					break;
			}
		});

	</script>
</body>
</html>
